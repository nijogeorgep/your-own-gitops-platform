{{/*
=============================================================================
KUBERNETES RESOURCE: Ingress
=============================================================================
Purpose: Expose HTTP/HTTPS routes from outside cluster to services
API: networking.k8s.io/v1
Condition: Only created when ingress.enabled=true
Controller Required: NGINX, Traefik, HAProxy, etc.

Features:
  - TLS/SSL termination
  - Name-based virtual hosting
  - Path-based routing
  - Load balancing

Exclusive: Do NOT enable both ingress and httpRoute simultaneously
Legacy: Consider migrating to HTTPRoute (Gateway API) for new deployments
*/}}
{{- if .Values.ingress.enabled -}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "cw-service.fullname" . }}
  labels:
    {{- include "cw-service.labels" . | nindent 4 }}
  {{- with .Values.ingress.annotations }}
  {{/*
  ===================================================================
  ANNOTATIONS
  ===================================================================
  Controller-specific configuration:
    - kubernetes.io/ingress.class: ingress controller selector (legacy)
    - cert-manager.io/cluster-issuer: auto TLS certificates
    - nginx.ingress.kubernetes.io/*: NGINX-specific settings
  */}}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- with .Values.ingress.className }}
  {{/* Ingress class (modern way to select controller) */}}
  ingressClassName: {{ . }}
  {{- end }}
  {{- if .Values.ingress.tls }}
  {{/*
  ===================================================================
  TLS CONFIGURATION
  ===================================================================
  HTTPS/SSL termination
  Requires: Secret with tls.crt and tls.key
  Can be auto-generated by cert-manager
  */}}
  tls:
    {{- range .Values.ingress.tls }}
    - hosts:
        {{- range .hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .secretName }}
    {{- end }}
  {{- end }}
  {{/*
  ===================================================================
  ROUTING RULES
  ===================================================================
  Host-based and path-based routing
  Each host can have multiple paths
  */}}
  rules:
    {{- range .Values.ingress.hosts }}
    - host: {{ .host | quote }}
      http:
        paths:
          {{- range .paths }}
          - path: {{ .path }}
            {{- with .pathType }}
            {{/* PathType: Exact, Prefix, or ImplementationSpecific */}}
            pathType: {{ . }}
            {{- end }}
            {{/* Backend service reference */}}
            backend:
              service:
                name: {{ include "cw-service.fullname" $ }}
                port:
                  number: {{ $.Values.service.port }}
          {{- end }}
    {{- end }}
{{- end }}
