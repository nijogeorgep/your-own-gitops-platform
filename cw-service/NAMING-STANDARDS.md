# Platform Naming Standards

This document defines the naming conventions used across all components of the GitOps platform.

## Overview

The platform uses **environment-aware naming** to ensure uniqueness, traceability, and clarity across multi-environment deployments (dev/staging/prod).

## Naming Patterns by Component

### 1. Kubernetes Resources (Helm Charts)

**Pattern:** `<app>-<env>-<flavor>-<region>`

**Components:**
- `app`: Service name (e.g., nginx, api-gateway)
- `env`: Environment (dev, staging, prod)
- `flavor`: Optional variant (api, worker, ui)
- `region`: Deployment region (us-east-1, eu-west-1)

**Examples:**
```
nginx-prod-us-east-1
nginx-prod-api-us-east-1  (with flavor)
api-gateway-staging-us-east-1
user-service-dev-worker-us-west-2
```

**Applied to:**
- Deployments
- Rollouts
- Services
- ConfigMaps
- Secrets
- Ingress/HTTPRoute
- HorizontalPodAutoscaler

**Generated by:** `cw-common.fullname` helper template

**Configuration:**
```yaml
# services/nginx/values-prod.yaml
environment: prod
region: us-east-1
# flavor: api  # Optional
```

**Constraints:**
- DNS-compliant (lowercase, hyphens only)
- Max 63 characters (automatic truncation)
- Empty components are skipped

---

### 2. Kargo Resources (Progressive Delivery)

**Patterns:**
- **Stages:** `<service>-<env>-<region>`
- **Warehouse:** `<service>-warehouse`
- **Project:** `<service>` (namespace: `kargo-<service>`)

**Examples:**
```yaml
# Stages
nginx-dev-us-east-1
nginx-staging-us-east-1
nginx-prod-us-east-1

# Warehouse
nginx-warehouse

# Project
nginx (in namespace: kargo-nginx)
```

**Labels (all resources):**
```yaml
labels:
  app.kubernetes.io/name: nginx
  app.kubernetes.io/environment: prod  # For stages
  app.kubernetes.io/region: us-east-1
  app.kubernetes.io/component: warehouse  # For warehouses
```

**Generation:**
```powershell
cd cw-kargo
.\generate-kargo-resources.ps1 -Region us-east-1

# Multi-region
.\generate-kargo-resources.ps1 -Region us-west-2
```

**Why this pattern:**
- ✅ Clear environment association
- ✅ Region-aware for multi-region deployments
- ✅ Consistent with Kubernetes resource names
- ✅ Easy to identify in Kargo UI

---

### 3. ArgoCD Applications (GitOps)

**Pattern:** `<service>-<env>`

**Examples:**
```
nginx-dev
nginx-staging
nginx-prod
api-gateway-dev
api-gateway-staging
api-gateway-prod
```

**Generated by:** ApplicationSet matrix generator

**Target namespace:** Matches environment (dev, staging, prod)

**ApplicationSet configuration:**
```yaml
# Automatically generates: nginx-dev, nginx-staging, nginx-prod
generators:
  - matrix:
      generators:
        - git:
            directories:
              - path: services/*
        - list:
            elements:
              - env: dev
              - env: staging
              - env: prod
```

---

### 4. Argo Workflows (CI/CD Pipelines)

**Patterns:**
- **WorkflowTemplate (reusable):** Descriptive name (NO service/env in name)
- **Workflow Instance:** `<prefix>-<random>` (ephemeral, auto-generated)

**Examples:**
```yaml
# WorkflowTemplate (shared template)
kind: WorkflowTemplate
metadata:
  name: build-push-image  # Reusable, no service name

# Workflow Instance (runtime execution)
kind: Workflow
metadata:
  generateName: image-update-  # Results in: image-update-abc123

# Service context passed as parameter
spec:
  arguments:
    parameters:
      - name: service-name
        value: nginx  # Service context, not in resource name
```

**WorkflowTemplate names:**
- `build-push-image` - Build container image with Kaniko
- `update-git-values` - Update values files in Git
- `deploy-service` - Deploy via ArgoCD
- `run-tests` - Execute test suites

**Why this pattern:**
- ✅ Templates are reusable across all services
- ✅ Workflow instances are ephemeral (auto-cleaned after TTL)
- ✅ Service context passed as parameters, not hardcoded
- ✅ Avoids template explosion (1 template for 1000 services)

---

### 5. Argo Events (Event Automation)

**Patterns:**
- **EventSource:** Platform-level name (shared infrastructure)
- **Sensor:** Workflow/pipeline name (shared across services)

**Examples:**
```yaml
# EventSource (shared)
kind: EventSource
metadata:
  name: github  # Listens to ALL GitHub webhooks
  namespace: argo-events

# EventSource (shared)
kind: EventSource
metadata:
  name: calendar  # Cron-based triggers
  namespace: argo-events

# Sensor (shared pipeline)
kind: Sensor
metadata:
  name: image-update-pipeline  # Triggers for ANY service
  namespace: argo-events
```

**Why this pattern:**
- ✅ Event infrastructure is shared across all services
- ✅ Service context determined dynamically from event payload
- ✅ Avoids creating 1000+ EventSources/Sensors
- ✅ Centralized event management

**Service detection:**
```yaml
# Sensor detects service from modified files
filters:
  data:
    - path: body.commits.#.modified
      comparator: "~"
      value:
        - "^services/(?P<service>.*)/.*"  # Extract service name
```

---

## Comparison Table

| Component | Pattern | Example | Service in Name? | Environment in Name? | Region in Name? |
|-----------|---------|---------|------------------|----------------------|-----------------|
| **Deployment** | `<app>-<env>-<region>` | `nginx-prod-us-east-1` | ✅ | ✅ | ✅ |
| **Rollout** | `<app>-<env>-<region>` | `nginx-prod-us-east-1` | ✅ | ✅ | ✅ |
| **Service** | `<app>-<env>-<region>` | `nginx-prod-us-east-1` | ✅ | ✅ | ✅ |
| **Kargo Stage** | `<service>-<env>-<region>` | `nginx-dev-us-east-1` | ✅ | ✅ | ✅ |
| **Kargo Warehouse** | `<service>-warehouse` | `nginx-warehouse` | ✅ | ❌ | ❌ |
| **Kargo Project** | `<service>` | `nginx` | ✅ | ❌ | ❌ |
| **ArgoCD App** | `<service>-<env>` | `nginx-prod` | ✅ | ✅ | ❌ |
| **WorkflowTemplate** | `<purpose>` | `build-push-image` | ❌ | ❌ | ❌ |
| **Workflow** | `<prefix>-<random>` | `image-update-abc123` | ❌ | ❌ | ❌ |
| **EventSource** | `<provider>` | `github` | ❌ | ❌ | ❌ |
| **Sensor** | `<pipeline>` | `image-update-pipeline` | ❌ | ❌ | ❌ |

## Design Rationale

### Why service-specific naming for Kubernetes/Kargo?

**Problem:** In multi-service, multi-environment platforms:
- Same service deployed to dev/staging/prod needs unique names
- Multiple regions require distinct resource names
- Cross-environment queries need clear identification

**Solution:** Environment-aware naming
```
nginx-dev-us-east-1     # Dev environment
nginx-staging-us-east-1 # Staging environment
nginx-prod-us-east-1    # Production environment
```

**Benefits:**
- ✅ **Uniqueness:** No name collisions across environments
- ✅ **Traceability:** Resource name reveals environment/region
- ✅ **Observability:** Metrics/logs easily filtered by environment
- ✅ **Multi-region:** Support for regional deployments

### Why NOT service-specific naming for Workflows/Events?

**Problem:** Creating per-service WorkflowTemplates/EventSources:
- 1000 services × 3 templates = 3000 WorkflowTemplates
- Duplicated logic across templates
- Difficult to update workflow logic (must update 1000 files)

**Solution:** Shared templates with parameterization
```yaml
# ONE template, used by ALL services
kind: WorkflowTemplate
metadata:
  name: build-push-image  # Shared

# Runtime invocation with parameters
parameters:
  - name: service-name
    value: nginx  # Dynamic service context
```

**Benefits:**
- ✅ **DRY Principle:** One template definition
- ✅ **Maintainability:** Update once, applies to all services
- ✅ **Scalability:** 3 templates support 1000+ services
- ✅ **Consistency:** Same workflow logic for all services

### Why region in Kubernetes but not ArgoCD Apps?

**Kubernetes resources:**
- Can deploy same service to multiple regions simultaneously
- Example: `nginx-prod-us-east-1` and `nginx-prod-eu-west-1` coexist

**ArgoCD Applications:**
- Typically one Application per environment per service
- Region specified in values files, not Application name
- Simplifies ApplicationSet generator (2 dimensions: services × environments)

## Multi-Region Deployments

### Pattern for multi-region support:

**Option 1: Separate ArgoCD Applications per region**
```yaml
# ApplicationSet generator
- list:
    elements:
      - env: prod
        region: us-east-1
      - env: prod
        region: eu-west-1

# Results in:
# nginx-prod-us-east-1 (Application)
# nginx-prod-eu-west-1 (Application)
```

**Option 2: Single Application, region in values**
```yaml
# ArgoCD Application
name: nginx-prod

# Values file determines region
# values-prod.yaml
region: us-east-1
```

**Current platform uses Option 2** (simpler ApplicationSet, region in values)

## Validation Rules

### Kubernetes Resources (Helm)
- ✅ Must include `environment`
- ✅ Must include `region`
- ✅ `flavor` is optional
- ✅ Max 63 characters (DNS compliance)
- ✅ Lowercase, hyphens only

### Kargo Stages
- ✅ Must follow `<service>-<env>-<region>`
- ✅ Must have labels: `app.kubernetes.io/name`, `app.kubernetes.io/environment`, `app.kubernetes.io/region`
- ✅ Namespace must be `kargo-<service>`

### Argo Workflows
- ✅ WorkflowTemplate names must be descriptive (purpose-based, not service-based)
- ✅ Must accept service name as parameter
- ✅ Workflow instances use `generateName` with prefix

### Argo Events
- ✅ EventSource names describe provider (github, calendar, webhook)
- ✅ Sensor names describe pipeline/workflow triggered
- ✅ Must extract service context from event payload dynamically

## Migration Guide

### Updating existing Kargo resources to new naming:

**Old (incorrect):**
```yaml
kind: Stage
metadata:
  name: dev  # Too generic
```

**New (correct):**
```yaml
kind: Stage
metadata:
  name: nginx-dev-us-east-1  # Specific
  labels:
    app.kubernetes.io/name: nginx
    app.kubernetes.io/environment: dev
    app.kubernetes.io/region: us-east-1
```

**Regenerate resources:**
```powershell
cd cw-kargo
.\generate-kargo-resources.ps1 -Region us-east-1 -Force
.\deploy.ps1
```

## Reference Implementation

See these files for complete examples:
- **Kubernetes:** [cw-service/values.yaml](../cw-service/values.yaml)
- **Kargo:** [cw-kargo/templates/stages.yaml.template](../cw-kargo/templates/stages.yaml.template)
- **Workflows:** [cw-workflows/workflowtemplate-build-image.yaml](../cw-workflows/workflowtemplate-build-image.yaml)
- **Events:** [cw-events/sensor-image-update.yaml](../cw-events/sensor-image-update.yaml)
- **ArgoCD:** [cw-argo-bootstrap/applicationset-services.yaml](../cw-argo-bootstrap/applicationset-services.yaml)
